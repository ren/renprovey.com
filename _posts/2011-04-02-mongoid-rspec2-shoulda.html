---
layout: default
title: Mongoid, Shoulda & RSpec2 Configuration Tips
categories: rspec mongoid
published: true
synopsis: "Mongoid, Shouda & RSpec2 on Ruby 1.9.2 config tips."
---

<article>
  <h1>Mongoid, Shoulda &amp; RSpec2 Integration</h1>

  <p>I spent a good amount of time googling to get Shoulda matchers running with RSpec2 and Mongoid.  For kicks I was running Ruby 1.9.2, which I don't think was coming in to play, but is worth mentioning. The specific error I was getting was: <code>undefined method `validate_presence_of' for #&lt;RSpec::Core::ExampleGroup::Nested_2:0x00000103f81250&gt;</code>. Apparently Shoulda and Spork aren't quite compatible out of the box, but the fix turned out to be pretty straight forward.  File by file below is what I did to get things running.</p>

  <p>Changes to my <code>Gemfile</code>:</p>
  <code>
    group :development, :test do<br/>
      gem 'rspec-rails', '~> 2.5.0'<br/>

      gem 'shoulda'<br/>
      # gem 'shoulda-matchers', :require => false<br/>

      gem 'spork', '>= 0.9.0.rc4'<br/>
      gem 'launchy'    # So you can do Then show me the page<br/>
    end<br/>
  </code>

  <p>For <code>spec/spec_helper.rb</code>, just adding <code>require 'shoulda/integrations/rspec2'</code> and commenting out other references to shoulda, like: <code>require 'shoulda-matchers'</code> should work.  But for the sake of completeness, I had already run dove into Spork by running <code>spork --bootstrap</code> and ended up with the following:</p>
  
  <code>
    require 'spork'<br/>

    Spork.prefork do<br/>
      # Loading more in this block will cause your tests to run faster. However,<br/>
      # if you change any configuration or code from libraries loaded here, you'll<br/>
      # need to restart spork for it take effect.<br/>

      # This file is copied to spec/ when you run 'rails generate rspec:install'<br/>
      ENV["RAILS_ENV"] ||= 'test'<br/>
      require File.expand_path("../../config/environment", __FILE__)<br/>
      require 'rspec/rails'<br/>
      require 'factory_girl_rails'<br/>
      # require 'shoulda-matchers'<br/>
      require 'shoulda/integrations/rspec2'<br/>
<br/>
      require 'database_cleaner'<br/>
<br/>
      # Requires supporting ruby files with custom matchers and macros, etc,<br/>
      # in spec/support/ and its subdirectories.<br/>
      Dir[Rails.root.join("spec/support/**/*.rb")].each {|f| require f}<br/>
<br/>
      require File.expand_path("../../test/factory", __FILE__)<br/>
<br/>
      RSpec.configure do |config|<br/>
        # config.include Devise::TestHelpers, :type => :controller<br/>
        config.mock_with :rspec<br/>
<br/>
        DatabaseCleaner.strategy = :truncation<br/>
<br/>
        config.before(:each) do<br/>
          DatabaseCleaner.start<br/>
        end<br/>
<br/>
        config.after(:each) do<br/>
          DatabaseCleaner.clean<br/>
        end<br/>
      end<br/>
    end<br/>
<br/>
    Spork.each_run do<br/>
      # This code will be run each time you run your specs.<br/>
    end<br/>
  </code><br/>
  
  <p>Ok campers, have fun.</p>
  
  <p>Am I an idiot? Found a better way, please email and I'll update the example.  I culled this information form two helpful sources: <a href="http://stackoverflow.com/questions/2590796/shoulda-macros-with-rspec2-beta-5-and-rails3-beta2">Stack Overflow</a> for the <code>require 'shoulda/integrations/rspec2'</code> tip and <a href="http://www.rubyinside.com/how-to-rails-3-and-rspec-2-4336.html">Ruby Inside</a> for the Spork stuff.</p>
  
  <a href="{{ page.url }}" class="permalink">{{ page.date | date: "%B %d %Y" }}</a>
</article>
